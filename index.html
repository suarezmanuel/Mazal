<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Voting App</title>

<style>
body { font-family: Arial; direction: rtl; margin: 20px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill,120px); gap: 15px; }
.card { border: 2px solid #ccc; padding: 10px; text-align: center; cursor: pointer; }
.card.selected { background: lightgreen; }
img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; }
.admin { background: #eee; padding: 10px; margin-bottom: 15px; }
</style>
</head>

<body>

<h2 id="title">转专转</h2>

<div id="login">
  <button onclick="login('user')">砖转砖</button>
  <button onclick="login('admin')"></button>
</div>

<div id="app" style="display:none">
  <div id="adminPanel" class="admin" style="display:none">
    <h3>驻 </h3>
    砖: <input id="nameInput">
    转 (URL): <input id="imgInput">
    <button onclick="addPerson()">住祝</button>
    <button onclick="resetDB()">专拽  转</button>
    <p>: <span id="presenceCount">0</span></p>
  </div>

  <div class="grid" id="grid"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  //  Firebase 砖
  const firebaseConfig = {
    apiKey: "AIzaSyCqJpALniocZnIiA-tsHd6VHp1sODOBMjU",
    authDomain: "mazal-63e38.firebaseapp.com",
    projectId: "mazal-63e38",
    storageBucket: "mazal-63e38.firebasestorage.app",
    messagingSenderId: "262143581901",
    appId: "1:262143581901:web:43934f7271f9b8f9bad384",
    measurementId: "G-B3EHF7MM91",
    databaseURL: "https://mazal-63e38-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);

  const db = getDatabase(app);
  const auth = getAuth(app);

  let userId = null;
  let role = null;
  const ADMIN_PASSWORD = "1234";

  signInAnonymously(auth);

  onAuthStateChanged(auth, user => {
    if (user) userId = user.uid;
  });

  window.login = function(type) {
    if (type === "admin") {
      if (prompt("住住转 ") !== ADMIN_PASSWORD) {
        alert("砖");
        return;
      }
      adminPanel.style.display = "block";
    }
    role = type;
    login.style.display = "none";
    app.style.display = "block";
    title.innerText = "砖 " + role;
    updatePresence();
    listen();
  };

  window.addPerson = function() {
    if (!nameInput.value) return;
    push(ref(db, "people"), {
      name: nameInput.value,
      img: imgInput.value
    });
    nameInput.value = "";
    imgInput.value = "";
  };

  window.vote = function(id) {
    if (role !== "user") return;
    set(ref(db, "votes/" + userId), id);
  };

  window.resetDB = function() {
    if (!confirm("拽 ?")) return;
    set(ref(db), {});
  };

  function updatePresence() {
    set(ref(db, "presence/" + userId), Date.now());
    setInterval(() => {
      set(ref(db, "presence/" + userId), Date.now());
    }, 10000);
  }

  function listen() {
    onValue(ref(db, "people"), snap => {
      const people = snap.val() || {};
      onValue(ref(db, "votes"), vSnap => {
        render(people, vSnap.val() || {});
      });
    });

    onValue(ref(db, "presence"), snap => {
      const now = Date.now();
      const active = Object.values(snap.val() || {})
        .filter(t => now - t < 30000).length;
      presenceCount.innerText = active;
    });
  }

  function render(people, votes) {
    grid.innerHTML = "";
    Object.entries(people).forEach(([id, p]) => {
      const count = Object.values(votes).filter(v => v === id).length;
      const div = document.createElement("div");
      div.className = "card";
      if (votes[userId] === id) div.classList.add("selected");
      div.onclick = () => vote(id);
      div.innerHTML = `
        <img src="${p.img || ''}">
        <div>${p.name}</div>
        ${role === "admin" ? `<small>爪注转: ${count}</small>` : ""}
      `;
      grid.appendChild(div);
    });
  }
</script>

</body>
</html>
