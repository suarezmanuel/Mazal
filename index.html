<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voting App - Firestore</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; background: #f0f2f5; padding-bottom: 100px; }
  .container { max-width: 500px; margin: 0 auto; padding: 15px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 15px; }
  
  .card { 
    background: white; border-radius: 12px; padding: 10px; text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; border: 2px solid transparent;
  }
  .card.selected { border-color: #007bff; background: #e7f3ff; }
  .card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #ddd; }
  
  .admin-tools { position: absolute; top: 5px; left: 5px; display: flex; gap: 5px; }
  .btn-small { background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 4px; padding: 2px 5px; font-size: 10px; cursor: pointer; }

  .panel { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; }
  input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
  
  #log { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: #222; color: #0f0; font-family: monospace; font-size: 11px; overflow-y: auto; padding: 10px; z-index: 1000; text-align: left; direction: ltr; }
  .hidden { display: none; }
</style>
</head>
<body>

<div class="container">
  <h2 id="viewTitle" style="text-align:center">כניסה למערכת</h2>

  <div id="loginView">
    <button onclick="login('user')">כניסת מצביע</button>
    <button style="background:#6c757d" onclick="login('admin')">כניסת מנהל</button>
  </div>

  <div id="appView" class="hidden">
    <div id="adminPanel" class="panel hidden">
      <strong>הוספת מועמד</strong>
      <input id="nameIn" placeholder="שם המועמד">
      <input type="file" id="fileIn" accept="image/*" style="margin-top:10px">
      <button onclick="addPerson()">שמור מועמד</button>
      <button style="background:#dc3545" onclick="clearVotes()">איפוס הצבעות בלבד</button>
    </div>

    <div id="grid" class="grid"></div>
  </div>
</div>

<div id="log">Logs started (Firestore)...<br></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const logBox = document.getElementById("log");
  function log(m) { logBox.innerHTML += `> ${m}<br>`; logBox.scrollTop = logBox.scrollHeight; }

  const firebaseConfig = {
    apiKey: "AIzaSyCqJpALniocZnIiA-tsHd6VHp1sODOBMjU",
    authDomain: "mazal-63e38.firebaseapp.com",
    projectId: "mazal-63e38",
    storageBucket: "mazal-63e38.appspot.com",
    messagingSenderId: "262143581901",
    appId: "1:262143581901:web:43934f7271f9b8f9bad384"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  let myId, role, myCurrentVoteDocId;

  signInAnonymously(auth).catch(e => log("Auth Error: " + e.message));
  onAuthStateChanged(auth, u => { if(u) { myId = u.uid; log("Connected to Firestore"); }});

  window.login = (r) => {
    if(r === 'admin' && prompt("סיסמה:") !== "1234") return;
    role = r;
    document.getElementById("loginView").classList.add("hidden");
    document.getElementById("appView").classList.remove("hidden");
    if(r === 'admin') document.getElementById("adminPanel").classList.remove("hidden");
    startSync();
  };

  window.addPerson = async () => {
    const name = document.getElementById("nameIn").value;
    const file = document.getElementById("fileIn").files[0];
    if(!name) return alert("הכנס שם");
    
    let imgBase64 = "";
    if(file) imgBase64 = await resizeImg(file);

    try {
      await addDoc(collection(db, "people"), { name, img: imgBase64 });
      log("Person added to Firestore");
      document.getElementById("nameIn").value = "";
    } catch(e) { log("Add Error: " + e.message); }
  };

  function startSync() {
    // Sync People
    onSnapshot(collection(db, "people"), (snap) => {
      const people = [];
      snap.forEach(d => people.push({ id: d.id, ...d.data() }));
      
      // Sync Votes
      onSnapshot(collection(db, "votes"), (vSnap) => {
        const votes = {};
        vSnap.forEach(v => { votes[v.id] = v.data().votedFor; });
        render(people, votes);
      });
    });
  }

  function render(people, votes) {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    const myVotedId = votes[myId];

    people.forEach(p => {
      const count = Object.values(votes).filter(v => v === p.id).length;
      const card = document.createElement("div");
      card.className = `card ${myVotedId === p.id ? 'selected' : ''}`;
      card.onclick = () => castVote(p.id);

      card.innerHTML = `
        <img src="${p.img || 'https://ui-avatars.com/api/?name='+p.name}">
        <div><strong>${p.name}</strong></div>
        ${role === 'admin' ? `<div>⭐ ${count}</div>
          <div class="admin-tools">
            <button class="btn-small" onclick="editPerson('${p.id}', '${p.name}', event)">✏️</button>
            <button class="btn-small" style="background:red" onclick="deletePerson('${p.id}', event)">✕</button>
          </div>` : ''}
      `;
      grid.appendChild(card);
    });
  }

  window.castVote = async (pId) => {
    if(role !== 'user') return;
    try {
      await setDoc(doc(db, "votes", myId), { votedFor: pId });
      log("Vote saved");
    } catch(e) { log("Vote Error: " + e.message); }
  };

  window.deletePerson = async (id, e) => {
    e.stopPropagation();
    if(confirm("למחוק?")) await deleteDoc(doc(db, "people", id));
  };

  window.editPerson = async (id, oldName, e) => {
    e.stopPropagation();
    const newName = prompt("שם חדש:", oldName);
    if(newName) await updateDoc(doc(db, "people", id), { name: newName });
  };

  window.clearVotes = async () => {
    if(!confirm("לאפס הצבעות?")) return;
    const vSnap = await getDocs(collection(db, "votes"));
    const batch = writeBatch(db);
    vSnap.forEach(d => batch.delete(d.ref));
    await batch.commit();
    log("Votes reset");
  };

  function resizeImg(file) {
    return new Promise(res => {
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const m = 120;
          let w = img.width, h = img.height;
          if(w > h) { if(w > m) { h *= m/w; w = m; } } else { if(h > m) { w *= m/h; h = m; } }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0,0,w,h);
          res(canvas.toDataURL("image/jpeg", 0.6));
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
