<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voting App - Multi-Vote</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; background: #f0f2f5; padding-bottom: 120px; }
  .container { max-width: 500px; margin: 0 auto; padding: 15px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 15px; }
  
  .card { 
    background: white; border-radius: 12px; padding: 10px; text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; border: 3px solid transparent;
  }
  .card.selected { border-color: #28a745; background: #f0fff4; }
  .card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #ddd; }
  
  .admin-tools { position: absolute; top: 5px; left: 5px; display: flex; gap: 5px; }
  .btn-small { background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 4px; padding: 4px 6px; font-size: 12px; cursor: pointer; }

  .panel { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
  
  button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; font-size: 16px; }
  input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
  
  #log { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: #222; color: #0f0; font-family: monospace; font-size: 10px; overflow-y: auto; padding: 8px; z-index: 1000; text-align: left; direction: ltr; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="container">
  <h2 id="viewTitle" style="text-align:center">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>

  <div id="loginView">
    <button onclick="login('user')">×›× ×™×¡×ª ××¦×‘×™×¢</button>
    <button style="background:#6c757d" onclick="login('admin')">×›× ×™×¡×ª ×× ×”×œ</button>
  </div>

  <div id="appView" class="hidden">
    <div id="adminPanel" class="panel hidden">
      <div class="stats-header">
        <span>× ×•×›×—×•×ª (×¢× ×”×¦×‘×¢×”): <span id="presenceText">0/0</span></span>
      </div>
      <input id="nameIn" placeholder="×©× ×”××•×¢××“">
      <input type="file" id="fileIn" accept="image/*" style="margin-top:10px">
      <button onclick="addPerson()">×©××•×¨ ××•×¢××“</button>
      <button style="background:#dc3545; font-size: 13px;" onclick="clearVotes()">××™×¤×•×¡ ×›×œ ×”×”×¦×‘×¢×•×ª</button>
    </div>

    <div id="grid" class="grid"></div>
  </div>
</div>

<div id="log">Logs started...</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, writeBatch, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqJpALniocZnIiA-tsHd6VHp1sODOBMjU",
    authDomain: "mazal-63e38.firebaseapp.com",
    projectId: "mazal-63e38",
    storageBucket: "mazal-63e38.appspot.com",
    messagingSenderId: "262143581901",
    appId: "1:262143581901:web:43934f7271f9b8f9bad384"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const logBox = document.getElementById("log");
  function log(m) { logBox.innerHTML += `> ${m}<br>`; logBox.scrollTop = logBox.scrollHeight; }

  let myId, role;
  let myVotes = []; // Store multiple vote IDs locally

  signInAnonymously(auth).catch(e => log("Auth Error: " + e.message));
  onAuthStateChanged(auth, u => { if(u) myId = u.uid; });

  // Handle Phone Back Button
  window.onhashchange = function() {
    if (!window.location.hash) {
      location.reload(); // Returns to login screen
    }
  };

  window.login = (r) => {
    if(r === 'admin' && prompt("×¡×™×¡××”:") !== "1234") return;
    role = r;
    window.location.hash = r; // Set hash for back button support
    document.getElementById("loginView").classList.add("hidden");
    document.getElementById("appView").classList.remove("hidden");
    if(r === 'admin') document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("viewTitle").innerText = r === 'admin' ? "× ×™×”×•×œ" : "×‘×—×™×¨×” ××¨×•×‘×”";
    startSync();
  };

  window.addPerson = async () => {
    const nameInput = document.getElementById("nameIn");
    const fileInput = document.getElementById("fileIn");
    const name = nameInput.value;
    const file = fileInput.files[0];
    
    if(!name) return alert("×”×›× ×¡ ×©×");
    
    log("Processing...");
    let imgBase64 = "";
    if(file) imgBase64 = await resizeImg(file);

    try {
      await addDoc(collection(db, "people"), { name, img: imgBase64 });
      log("Success!");
      // CRITICAL: Reset inputs correctly
      nameInput.value = "";
      fileInput.value = ""; 
    } catch(e) { log("Error: " + e.message); }
  };

  function startSync() {
    onSnapshot(collection(db, "people"), (pSnap) => {
      const people = [];
      pSnap.forEach(d => people.push({ id: d.id, ...d.data() }));
      
      onSnapshot(collection(db, "votes"), (vSnap) => {
        const allVotes = []; 
        vSnap.forEach(v => {
            const data = v.data();
            // Data structure: { voterId: "uid", votedFor: ["id1", "id2"] }
            allVotes.push({voter: v.id, targets: data.targets || []});
        });
        
        // Find my specific votes
        const myVoteEntry = allVotes.find(v => v.voter === myId);
        myVotes = myVoteEntry ? myVoteEntry.targets : [];
        
        render(people, allVotes);
      });
    });
  }

  function render(people, allVotes) {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    // Calculate Admin Stats
    // "Present" = People who have received at least one vote
    const votedTargetIds = new Set();
    allVotes.forEach(v => v.targets.forEach(tId => votedTargetIds.add(tId)));
    
    if(role === 'admin') {
      document.getElementById("presenceText").innerText = `${votedTargetIds.size} / ${people.length}`;
    }

    people.forEach(p => {
      // Count total votes for this specific person
      const totalForThisPerson = allVotes.reduce((acc, curr) => acc + (curr.targets.includes(p.id) ? 1 : 0), 0);
      const isSelected = myVotes.includes(p.id);

      const card = document.createElement("div");
      card.className = `card ${isSelected ? 'selected' : ''}`;
      card.onclick = () => toggleMultiVote(p.id);

      card.innerHTML = `
        <img src="${p.img || 'https://ui-avatars.com/api/?background=random&name='+p.name}">
        <div style="margin-top:5px; font-weight:bold">${p.name}</div>
        ${role === 'admin' ? `
          <div style="color:#007bff; font-weight:bold; font-size:14px">ğŸ—³ï¸ ${totalForThisPerson}</div>
          <div class="admin-tools">
            <button class="btn-small" onclick="deletePerson('${p.id}', event)">âœ•</button>
          </div>` : ''}
      `;
      grid.appendChild(card);
    });
  }

  window.toggleMultiVote = async (pId) => {
    if(role !== 'user') return;
    
    let newVotes = [...myVotes];
    if (newVotes.includes(pId)) {
      newVotes = newVotes.filter(id => id !== pId); // Remove
    } else {
      newVotes.push(pId); // Add
    }

    try {
      await setDoc(doc(db, "votes", myId), { targets: newVotes });
    } catch(e) { log("Vote Error: " + e.message); }
  };

  window.deletePerson = async (id, e) => {
    e.stopPropagation();
    if(confirm("×œ××—×•×§ ×œ×¦××™×ª×•×ª?")) {
      await deleteDoc(doc(db, "people", id));
    }
  };

  window.clearVotes = async () => {
    if(!confirm("××™×¤×•×¡ ×›×œ ×”×”×¦×‘×¢×•×ª?")) return;
    const vSnap = await getDocs(collection(db, "votes"));
    const batch = writeBatch(db);
    vSnap.forEach(d => batch.delete(d.ref));
    await batch.commit();
    log("Votes reset.");
  };

  function resizeImg(file) {
    return new Promise(res => {
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const m = 180;
          let w = img.width, h = img.height;
          if(w > h) { if(w > m) { h *= m/w; w = m; } } else { if(h > m) { w *= m/h; h = m; } }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0,0,w,h);
          res(canvas.toDataURL("image/jpeg", 0.7));
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
