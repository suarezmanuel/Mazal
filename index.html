<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¢×¨×›×ª × ×•×›×—×•×ª ×§×‘×•×¦×ª×™×ª</title>
<style>
  /* --- Base Styles --- */
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; margin: 0; background: #f0f2f5; user-select: none; padding-bottom: 100px; }
  
  /* --- Header & Navigation --- */
  .header { 
    background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    position: sticky; top: 0; z-index: 50;
  }
  .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .header-top h2 { margin: 0; font-size: 18px; color: #333; }
  
  .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .search-row { display: flex; gap: 8px; flex-wrap: wrap; }
  
  .search-input { 
    flex: 2; min-width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
    font-size: 14px; outline: none;
  }

  .select-group {
    flex: 1; padding: 10px; border: 1px solid #007bff; border-radius: 8px;
    background: white; color: #007bff; font-weight: bold; outline: none; cursor: pointer;
  }

  .filter-btn {
    padding: 8px 15px; border: 1px solid #007bff; border-radius: 8px;
    background: white; color: #007bff; cursor: pointer; font-size: 14px; 
    white-space: nowrap; font-weight: bold;
  }
  .filter-btn.active { background: #007bff; color: white; }

  /* --- Admin UI Elements --- */
  .toggle-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
  .admin-only { display: none !important; }
  .admin-mode .admin-only { display: inline-block !important; }
  
  .delete-group-btn { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; border-radius: 8px; padding: 8px 12px; font-weight: bold; cursor: pointer; }
  .reset-votes-btn { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; border-radius: 8px; padding: 8px 12px; font-weight: bold; cursor: pointer; }
  .render-report-btn { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; border-radius: 8px; padding: 8px 12px; font-weight: bold; cursor: pointer; }

  /* --- Grid & Cards --- */
  .container { padding: 15px; max-width: 800px; margin: 0 auto; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }

  .card { 
    background: white; border-radius: 12px; padding: 12px; text-align: center; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 3px solid transparent;
    transition: background 0.3s; display: flex; flex-direction: column; align-items: center;
  }
  .card.present { background: #d4edda; border-color: #c3e6cb; }
  .card.selected { border-color: #28a745; border-width: 3px; }

  .card img { width: 85px; height: 85px; border-radius: 50%; object-fit: cover; background: #eee; margin-bottom: 8px; }

  .action-row { display: flex; gap: 4px; width: 100%; margin-top: auto; padding-top: 10px; }
  .reason-btn { flex: 2; background: #e7f1ff; color: #007bff; border: 1px solid #b3d7ff; border-radius: 6px; font-size: 13px; padding: 6px 0; cursor: pointer; }
  .admin-btn { flex: 1; background: #f8f9fa; color: #555; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; padding: 6px 0; cursor: pointer; }
  .btn-delete { color: #d32f2f; background: #ffebee; border-color: #ffcdd2; }
  .btn-edit { color: #1976d2; background: #e3f2fd; border-color: #bbdefb; }

  /* --- MODAL STYLES (Added these to fix your popup issue) --- */
  .hidden { display: none !important; }
  
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); z-index: 1000;
    display: flex; justify-content: center; align-items: center;
  }

  .modal-box {
    background: white; width: 90%; max-width: 400px;
    border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; overflow: hidden;
  }

  .modal-header {
    padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
    font-weight: bold; font-size: 18px;
  }

  .modal-body {
    padding: 15px; display: flex; flex-direction: column; gap: 10px;
    max-height: 60vh; overflow-y: auto;
  }

  .modal-footer {
    padding: 15px; border-top: 1px solid #eee; background: #f8f9fa;
    display: flex; gap: 10px;
  }

  .modal-input {
    width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;
    box-sizing: border-box; font-size: 16px;
  }
  
  .modal-label { font-weight: bold; font-size: 14px; margin-top: 10px; display: block; }

  .modal-btn {
    flex: 1; padding: 10px; background: #007bff; color: white;
    border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
    text-align: center;
  }
  
  .reason-item {
    background: #e9ecef; padding: 8px 12px; border-radius: 6px;
    border-right: 4px solid #007bff; margin-bottom: 5px; font-size: 14px;
  }
</style>
</head>
<body id="mainBody">

<div class="header">
  <div class="header-top">
    <h2>× ×•×›×—×•×ª: <span id="pStat">0/0</span></h2>
    <div class="controls">
      <button class="render-report-btn" onclick="renderMissingImage()">ğŸ“¸ ×”×¤×§ ×“×•×— ×—×¡×¨×™×</button>
      <button class="reset-votes-btn admin-only" onclick="resetVotes()">â™»ï¸ ××™×¤×•×¡ × ×ª×•× ×™×</button>
      <button class="delete-group-btn admin-only" onclick="deleteCurrentGroup()">ğŸ—‘ï¸ ××—×§ ×§×‘×•×¦×”</button>
      <button id="lockBtn" class="toggle-btn" onclick="toggleAdmin()">ğŸ”’</button>
    </div>
  </div>
  <div class="search-row">
    <select id="groupSelect" class="select-group" onchange="handleGroupChange()">
        <option value="all">×›×œ ×”×§×‘×•×¦×•×ª</option>
    </select>
    <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×©×..." oninput="render()">
    <button id="filterBtn" class="filter-btn" onclick="toggleFilter()">×”×›×œ</button>
  </div>
</div>

<div class="container">
  <div id="grid" class="grid"></div>
</div>

<div id="addUserModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header"><span>×”×•×¡×¤×ª ××©×ª××© ×—×“×©</span><button onclick="closeModal('addUserModal')" style="border:none;background:none;font-size:20px;">âœ•</button></div>
      <div class="modal-body">
        <input id="newUserName" class="modal-input" placeholder="×©× ××œ×">
        <label class="modal-label">×ª××•× ×”:</label>
        <input type="file" id="newUserFile" accept="image/*" class="modal-input">
      </div>
      <div class="modal-footer"><button class="modal-btn" onclick="saveNewUser()">×©××•×¨ ××©×ª××©</button></div>
    </div>
</div>

<div id="editUserModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header"><span>×¢×¨×™×›×ª ×¤×¨×˜×™ ××©×ª××©</span><button onclick="closeModal('editUserModal')" style="border:none;background:none;font-size:20px;">âœ•</button></div>
        <div class="modal-body">
            <input id="editUserName" class="modal-input">
            <input type="file" id="editUserFile" accept="image/*" class="modal-input">
            <select id="editUserGroup" class="modal-input"></select>
        </div>
        <div class="modal-footer"><button class="modal-btn" onclick="saveEditUser()">×¢×“×›×Ÿ</button></div>
    </div>
</div>

<div id="addGroupModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header"><span>×™×¦×™×¨×ª ×§×‘×•×¦×”</span><button onclick="closeModal('addGroupModal')" style="border:none;background:none;font-size:20px;">âœ•</button></div>
        <div class="modal-body"><input id="newGroupName" class="modal-input" placeholder="×©× ×”×§×‘×•×¦×”"></div>
        <div class="modal-footer"><button class="modal-btn" onclick="saveNewGroup()">×¦×•×¨</button></div>
    </div>
</div>

<div id="reasonsModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header"><span id="reasonsTitle">×¡×™×‘×•×ª</span><button onclick="closeModal('reasonsModal')" style="border:none;background:none;font-size:20px;">âœ•</button></div>
      <div class="modal-body" id="reasonsList"></div>
      <div class="modal-footer">
        <input id="newReasonInput" class="modal-input" placeholder="×”×•×¡×£ ×¡×™×‘×”...">
        <button class="modal-btn" style="width:auto; flex:0 0 50px;" onclick="addReason()">+</button>
      </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqJpALniocZnIiA-tsHd6VHp1sODOBMjU",
    authDomain: "mazal-63e38.firebaseapp.com",
    projectId: "mazal-63e38",
    storageBucket: "mazal-63e38.appspot.com",
    messagingSenderId: "262143581901",
    appId: "1:262143581901:web:43934f7271f9b8f9bad384"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  let myId, isAdmin = false, myVotes = [], peopleData = [], votesData = [], groupsData = [], activePersonId = null, showOnlyAbsent = false, selectedGroupId = 'all';

  signInAnonymously(auth);
  onAuthStateChanged(auth, u => { if(u) { myId = u.uid; startSync(); } });

  function startSync() {
    onSnapshot(collection(db, "groups"), (snap) => {
      groupsData = [];
      snap.forEach(d => groupsData.push({ id: d.id, ...d.data() }));
      groupsData.sort((a, b) => a.name.localeCompare(b.name, 'he'));
      updateGroupDropdown();
    });

    onSnapshot(collection(db, "people"), (snap) => {
      peopleData = [];
      snap.forEach(d => peopleData.push({ id: d.id, ...d.data() }));
      peopleData.sort((a, b) => a.name.localeCompare(b.name, 'he'));
      render();
    });

    onSnapshot(collection(db, "votes"), (snap) => {
      votesData = [];
      snap.forEach(v => votesData.push({voter: v.id, targets: v.data().targets || []}));
      const myEntry = votesData.find(v => v.voter === myId);
      myVotes = myEntry ? myEntry.targets : [];
      render();
    });
  }

  function updateGroupDropdown() {
    const sel = document.getElementById("groupSelect");
    const currentVal = sel.value;
    sel.innerHTML = `<option value="all">×›×œ ×”×§×‘×•×¦×•×ª</option>`;
    groupsData.forEach(g => {
        sel.innerHTML += `<option value="${g.id}">${g.name}</option>`;
    });
    if(isAdmin) sel.innerHTML += `<option value="ADD_NEW">+ ×”×•×¡×£ ×§×‘×•×¦×” ×—×“×©×”</option>`;
    sel.value = currentVal || 'all';
  }

  window.handleGroupChange = () => {
    const val = document.getElementById("groupSelect").value;
    if (val === "ADD_NEW") {
        document.getElementById("groupSelect").value = selectedGroupId;
        document.getElementById("addGroupModal").classList.remove("hidden");
    } else {
        selectedGroupId = val;
        render();
    }
  };


  window.resetVotes = async () => {
    const isAll = selectedGroupId === 'all';
    if (!confirm(isAll ? "××™×¤×•×¡ ×›×œ ×”××¢×¨×›×ª?" : "××™×¤×•×¡ ×§×‘×•×¦×” ×–×•?")) return;
    const batch = writeBatch(db);
    const targetPeople = isAll ? peopleData : peopleData.filter(p => p.groupId === selectedGroupId);
    const targetIds = targetPeople.map(p => p.id);
    targetPeople.forEach(p => batch.update(doc(db, "people", p.id), { reasons: [] }));
    votesData.forEach(v => {
        const newTargets = v.targets.filter(tId => !targetIds.includes(tId));
        if (newTargets.length !== v.targets.length) batch.update(doc(db, "votes", v.voter), { targets: newTargets });
    });
    await batch.commit();
  };

  // --- UPDATED REPORT LOGIC ---
    window.renderMissingImage = () => {
    const reporterName = prompt("×©× ×”××“×•×•×—:");
    if (!reporterName) return;
    const reporterId = prompt("××–×”×” (ID):") || "";
    const location = prompt("××™×§×•×:") || "×œ× ×¦×•×™×Ÿ";

    // --- 1. Filter Data ---
    const targetPeople = (selectedGroupId === 'all') 
        ? peopleData 
        : peopleData.filter(p => p.groupId === selectedGroupId);

    // --- 2. Calculate Stats ---
    const voteCounts = {};
    targetPeople.forEach(p => voteCounts[p.id] = 0);
    votesData.forEach(v => v.targets.forEach(tId => { 
        if(voteCounts.hasOwnProperty(tId)) voteCounts[tId]++; 
    }));

    const missingList = targetPeople.filter(p => voteCounts[p.id] === 0);
    
    // Stats
    const totalCount = targetPeople.length;
    const presentCount = targetPeople.length - missingList.length;
    const missingCount = missingList.length;

    // --- 3. Canvas Setup ---
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Dimensions
    const topMargin = 140; // Space at top for header info
    const rightMargin = 100; // Sidebar space
    const rowHeight = 50;  
    
    // Calculate Height: Header + Stats lines + List + Footer Buffer
    // Added extra buffer (+8 rows) to ensure footer is far from bottom edge
    const totalContentRows = 5 + missingList.length + 8; 
    canvas.width = 1000;
    canvas.height = Math.max(900, topMargin + (totalContentRows * rowHeight));

    // --- 4. Background & Notebook Lines ---
    ctx.fillStyle = '#fdfbf7'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Horizontal Lines (Light Blue)
    ctx.strokeStyle = '#a4c2f4'; 
    ctx.lineWidth = 2;
    for (let y = topMargin; y < canvas.height - 100; y += rowHeight) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }

    // Vertical Margin Line (Soft Red/Pink)
    ctx.strokeStyle = '#e0a6aa';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(canvas.width - rightMargin, 0);
    ctx.lineTo(canvas.width - rightMargin, canvas.height);
    ctx.stroke();

    // --- 5. Content Configuration ---
    const contentRight = canvas.width - rightMargin - 20; 
    const dateObj = new Date();
    const dateStr = `${dateObj.getDate()}/${dateObj.getMonth()+1}/${dateObj.getFullYear()}`;
    const timeStr = `${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2,'0')}`;

    // --- A. Top Left Info (Date/Time/Location) ---
    ctx.textAlign = 'left';
    ctx.font = 'bold 24px Segoe UI';
    ctx.fillStyle = '#2980b9'; // Soft Blue
    
    // Positioned in the top white margin area
    ctx.fillText(`×ª××¨×™×š: ${dateStr}`, 40, 50);
    ctx.fillText(`×©×¢×”: ${timeStr}`, 40, 85);
    ctx.fillText(`××™×§×•×: ${location}`, 40, 120);

    // --- B. Top Right Stats ---
    ctx.textAlign = 'right';
    let currentLineY = topMargin + rowHeight - 12; // Start on first line

    // Line 1: Total
    ctx.font = 'bold 28px Segoe UI';
    ctx.fillStyle = '#2d3436'; 
    ctx.fillText(`××¦×Ÿ: ${totalCount}`, contentRight, currentLineY);
    
    // Line 2: Present
    currentLineY += rowHeight;
    ctx.fillStyle = '#27ae60'; 
    ctx.fillText(`× ×•×›×—×™×: ${presentCount}`, contentRight, currentLineY);

    // Line 3: Missing
    currentLineY += rowHeight;
    ctx.fillStyle = '#c0392b'; 
    ctx.fillText(`×—×¡×¨×™×: ${missingCount}`, contentRight, currentLineY);

    // --- C. Column Headers ---
    currentLineY += rowHeight * 1.5; // Gap before list
    ctx.fillStyle = '#2d3436';
    ctx.font = 'bold 28px Segoe UI';
    
    // Draw Headers
    ctx.fillText("×©×", contentRight, currentLineY);
    ctx.fillText("×¡×™×‘×”", contentRight - 350, currentLineY);
    
    // Underline headers
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#2d3436';
    ctx.beginPath();
    ctx.moveTo(contentRight, currentLineY + 5);
    ctx.lineTo(contentRight - 40, currentLineY + 5);
    ctx.moveTo(contentRight - 350, currentLineY + 5);
    ctx.lineTo(contentRight - 410, currentLineY + 5);
    ctx.stroke();

    // --- D. The List ---
    ctx.font = '26px Segoe UI';
    missingList.forEach((p) => {
        currentLineY += rowHeight;
        
        // Name
        ctx.fillStyle = '#2d3436'; 
        ctx.textAlign = 'right';
        ctx.fillText(p.name, contentRight, currentLineY - 10);
        
        // Reason
        if (p.reasons && p.reasons.length > 0) {
            ctx.fillStyle = '#7f8c8d'; // Grey
            let rText = p.reasons.join(", ");
            if (rText.length > 35) rText = rText.substring(0,35) + "...";
            ctx.fillText(rText, contentRight - 350, currentLineY - 10);
        }
    });

    // --- E. Footer: Author Info ---
    // Position relatively, but ensure it's not at the very bottom
    // We utilize the extra buffer we added to canvas height
    const footerY = currentLineY + 150; 
    
    ctx.textAlign = 'center';
    ctx.fillStyle = '#2c3e50'; 
    ctx.font = 'bold 40px Segoe UI';
    
    ctx.fillText(`××“×•×•×—: ${reporterName}`, canvas.width / 2, footerY);
    
    if (reporterId) {
        ctx.font = 'bold 32px Segoe UI';
        ctx.fillStyle = '#576574';
        ctx.fillText(`ID: ${reporterId}`, canvas.width / 2, footerY + 50);
    }

    // --- Download ---
    const link = document.createElement('a');
    link.download = `notebook_report_${dateStr.replace(/\//g,'-')}.png`;
    link.href = canvas.toDataURL();
    link.click();
  };


  window.render = () => {
    const grid = document.getElementById("grid");
    const searchText = document.getElementById("searchInput").value.toLowerCase();
    grid.innerHTML = "";

    let displayList = (selectedGroupId === 'all') ? peopleData : peopleData.filter(p => p.groupId === selectedGroupId);
    if (searchText) displayList = displayList.filter(p => p.name.toLowerCase().includes(searchText));

    const voteCounts = {};
    peopleData.forEach(p => voteCounts[p.id] = 0);
    votesData.forEach(v => v.targets.forEach(tId => { if(voteCounts.hasOwnProperty(tId)) voteCounts[tId]++; }));

    const uniqueArrived = displayList.filter(p => voteCounts[p.id] > 0).length;
    document.getElementById("pStat").innerText = `${uniqueArrived} / ${displayList.length}`;

    if (isAdmin && selectedGroupId !== 'all') {
      const plus = document.createElement("div");
      plus.className = "card"; plus.style.borderStyle = "dashed"; plus.style.borderColor = "#007bff";
      plus.onclick = () => document.getElementById("addUserModal").classList.remove("hidden");
      plus.innerHTML = `<span style="font-size:40px; color:#007bff">+</span><span style="color:#007bff">×”×•×¡×£ ××©×ª××©</span>`;
      grid.appendChild(plus);
    }

    displayList.forEach(p => {
      const vCount = voteCounts[p.id];
      if (showOnlyAbsent && vCount > 0) return;

      const card = document.createElement("div");
      card.className = `card ${myVotes.includes(p.id) ? 'selected' : ''} ${vCount > 0 ? 'present' : ''}`;
      card.onclick = (e) => { if(!e.target.closest('button')) toggleVote(p.id); };
      
      card.innerHTML = `
        <img src="${p.img || 'https://ui-avatars.com/api/?background=random&name='+p.name}">
        <div style="font-weight:bold; font-size:14px;">${p.name}</div>
        <div style="font-size:11px; color:#444; font-weight:bold;">ğŸ—³ï¸ ×”×¦×‘×¢×•×ª: ${vCount}</div>
        <div class="action-row">
          <button class="reason-btn" onclick="openReasonsModal('${p.id}')">ğŸ’¬ ${p.reasons?.length || 0}</button>
          ${isAdmin ? `<button class="admin-btn btn-edit" onclick="openEditModal('${p.id}')">âœï¸</button>` : ''}
          ${isAdmin ? `<button class="admin-btn btn-delete" onclick="deleteUser('${p.id}')">âœ•</button>` : ''}
        </div>`;
      grid.appendChild(card);
    });
  };

  async function toggleVote(id) {
    let newVotes = myVotes.includes(id) ? myVotes.filter(v => v !== id) : [...myVotes, id];
    await setDoc(doc(db, "votes", myId), { targets: newVotes });
  }

  window.toggleAdmin = () => {
    if (!isAdmin) {
      if (prompt("×¡×™×¡××”:") !== "1234") return;
      isAdmin = true;
      document.getElementById("lockBtn").innerText = "ğŸ”“";
      document.getElementById("mainBody").classList.add("admin-mode");
    } else {
      isAdmin = false;
      document.getElementById("lockBtn").innerText = "ğŸ”’";
      document.getElementById("mainBody").classList.remove("admin-mode");
    }
    updateGroupDropdown();
    render();
  };

  window.toggleFilter = () => {
    showOnlyAbsent = !showOnlyAbsent;
    document.getElementById("filterBtn").innerText = showOnlyAbsent ? "×—×¡×¨×™×" : "×”×›×œ";
    document.getElementById("filterBtn").classList.toggle("active", showOnlyAbsent);
    render();
  };

  window.saveNewUser = async () => {
    const name = document.getElementById("newUserName").value;
    const fileInput = document.getElementById("newUserFile");
    const img = fileInput.files[0] ? await resizeImg(fileInput.files[0]) : "";
    await addDoc(collection(db, "people"), { name, img, reasons: [], groupId: selectedGroupId });
    closeModal('addUserModal');
  };

  window.openEditModal = (id) => {
    activePersonId = id;
    const p = peopleData.find(x => x.id === id);
    document.getElementById("editUserName").value = p.name;
    const groupDropdown = document.getElementById("editUserGroup");
    groupDropdown.innerHTML = groupsData.map(g => `<option value="${g.id}" ${g.id === p.groupId ? 'selected' : ''}>${g.name}</option>`).join('');
    document.getElementById("editUserModal").classList.remove("hidden");
  };

  window.saveEditUser = async () => {
    const updates = { name: document.getElementById("editUserName").value, groupId: document.getElementById("editUserGroup").value };
    const fileInput = document.getElementById("editUserFile");
    if (fileInput.files[0]) updates.img = await resizeImg(fileInput.files[0]);
    await updateDoc(doc(db, "people", activePersonId), updates);
    closeModal('editUserModal');
  };

  window.openReasonsModal = (id) => {
    activePersonId = id;
    const p = peopleData.find(x => x.id === id);
    document.getElementById("reasonsTitle").innerText = "×¡×™×‘×•×ª: " + p.name;
    const list = document.getElementById("reasonsList");
    list.innerHTML = p.reasons?.length ? p.reasons.map(r => `<div class="reason-item">${r}</div>`).join('') : "××™×Ÿ ×¡×™×‘×•×ª ×¨×©×•××•×ª";
    document.getElementById("reasonsModal").classList.remove("hidden");
  };

  window.addReason = async () => {
    const val = document.getElementById("newReasonInput").value.trim();
    if(!val) return;
    await updateDoc(doc(db, "people", activePersonId), { reasons: arrayUnion(val) });
    document.getElementById("newReasonInput").value = "";
    // Wait slightly to refresh UI locally or just wait for snapshot
    setTimeout(() => openReasonsModal(activePersonId), 300);
  };

  window.deleteUser = async (id) => { if(confirm("×œ××—×•×§?")) await deleteDoc(doc(db, "people", id)); };
  window.closeModal = (id) => document.getElementById(id).classList.add("hidden");
  window.saveNewGroup = async () => {
    const name = document.getElementById("newGroupName").value;
    if(name) await addDoc(collection(db, "groups"), { name });
    closeModal('addGroupModal');
  };

  function resizeImg(file) {
    return new Promise(res => {
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const m = 180; let w = img.width, h = img.height;
          if(w > h) { if(w > m) { h *= m/w; w = m; } } else { if(h > m) { w *= m/h; h = m; } }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0,0,w,h);
          res(canvas.toDataURL("image/jpeg", 0.7));
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
