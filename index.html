<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voting & Presence App</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; background: #f8f9fa; user-select: none; }
  .header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); sticky: top; }
  .container { padding: 15px; max-width: 600px; margin: 0 auto; }
  
  /* Grid & Cards */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
  .card { 
    background: white; border-radius: 15px; padding: 12px; text-align: center; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; position: relative; border: 3px solid transparent;
    transition: transform 0.1s;
  }
  .card:active { transform: scale(0.96); }
  .card.selected { border-color: #28a745; background: #f0fff4; }
  .card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #eee; }
  
  /* Admin Extension Styles */
  .plus-card { border: 2px dashed #007bff; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #007bff; min-height: 130px; }
  .admin-badge { position: absolute; top: 5px; right: 5px; background: #ffc107; font-size: 10px; padding: 2px 5px; border-radius: 5px; }
  .edit-trigger { background: #007bff; color: white; border: none; border-radius: 4px; padding: 3px 8px; font-size: 11px; margin-top: 5px; }

  /* Utilities */
  .hidden { display: none !important; }
  button { cursor: pointer; }
  #log { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #222; color: #0f0; font-family: monospace; font-size: 10px; overflow-y: auto; padding: 5px; z-index: 1000; opacity: 0.8; }
</style>
</head>
<body>

<div class="header">
  <div id="presenceDisplay">转: <span id="pStat">0/0</span></div>
  <button id="adminBtn" onclick="toggleAdmin()" style="background:none; border:none; font-size:20px;"></button>
</div>

<div class="container">
  <div id="grid" class="grid"></div>
</div>

<div id="log">注专转 ...</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, writeBatch, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqJpALniocZnIiA-tsHd6VHp1sODOBMjU",
    authDomain: "mazal-63e38.firebaseapp.com",
    projectId: "mazal-63e38",
    storageBucket: "mazal-63e38.appspot.com",
    messagingSenderId: "262143581901",
    appId: "1:262143581901:web:43934f7271f9b8f9bad384"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  let myId, isAdmin = false, myVotes = [];
  let pressTimer;

  // --- Auth & Init ---
  signInAnonymously(auth);
  onAuthStateChanged(auth, u => { if(u) { myId = u.uid; startSync(); } });

  // --- Admin Toggle ---
  window.toggleAdmin = () => {
    if(!isAdmin) {
      const p = prompt("住住转 :");
      if(p === "1234") {
        isAdmin = true;
        document.getElementById("adminBtn").innerText = "";
        document.getElementById("log").innerText = "爪  驻注";
      }
    } else {
      isAdmin = false;
      document.getElementById("adminBtn").innerText = "";
    }
    // Refresh view
  };

  // --- Core Sync ---
  function startSync() {
    onSnapshot(collection(db, "people"), (pSnap) => {
      const people = [];
      pSnap.forEach(d => people.push({ id: d.id, ...d.data() }));
      
      onSnapshot(collection(db, "votes"), (vSnap) => {
        const votes = [];
        vSnap.forEach(v => votes.push({voter: v.id, targets: v.data().targets || []}));
        const myEntry = votes.find(v => v.voter === myId);
        myVotes = myEntry ? myEntry.targets : [];
        render(people, votes);
      });
    });
  }

  // --- UI Rendering ---
  function render(people, votes) {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    // 1. If Admin, show "Add" card first
    if(isAdmin) {
      const plus = document.createElement("div");
      plus.className = "card plus-card";
      plus.onclick = addPersonPrompt;
      plus.innerHTML = `<span style="font-size:40px">+</span><span>住祝 砖转砖</span>`;
      grid.appendChild(plus);
    }

    // 2. Render People
    const votedTargetIds = new Set();
    votes.forEach(v => v.targets.forEach(tId => votedTargetIds.add(tId)));
    document.getElementById("pStat").innerText = `${votedTargetIds.size} / ${people.length}`;

    people.forEach(p => {
      const isSelected = myVotes.includes(p.id);
      const totalVotes = votes.reduce((acc, curr) => acc + (curr.targets.includes(p.id) ? 1 : 0), 0);
      
      const card = document.createElement("div");
      card.className = `card ${isSelected ? 'selected' : ''}`;
      
      // Touch/Hold Events
      card.onmousedown = card.ontouchstart = (e) => startHold(p, e);
      card.onmouseup = card.ontouchend = () => clearHold();
      card.onclick = () => toggleVote(p.id);

      card.innerHTML = `
        <img src="${p.img || 'https://ui-avatars.com/api/?background=random&name='+p.name}">
        <div style="font-weight:bold; margin-top:5px;">${p.name}</div>
        ${isAdmin ? `<div style="font-size:12px; color:#007bff">爪注转: ${totalVotes}</div>
                    <button class="edit-trigger" onclick="editUser('${p.id}','${p.name}',event)">注专</button>` : ''}
      `;
      grid.appendChild(card);
    });
  }

  // --- Actions ---
  async function toggleVote(id) {
    let newVotes = [...myVotes];
    newVotes = newVotes.includes(id) ? newVotes.filter(v => v !== id) : [...newVotes, id];
    await setDoc(doc(db, "votes", myId), { targets: newVotes });
  }

  async function addPersonPrompt() {
    const name = prompt("砖 砖转砖 砖:");
    if(!name) return;
    // For phone simplicity, we use the default UI-Avatar unless you want to add a file input modal
    // To keep it clean, I'll add the person with a random avatar.
    await addDoc(collection(db, "people"), { name, img: "" });
  }

  window.editUser = async (id, oldName, e) => {
    e.stopPropagation();
    const action = prompt("拽 'save' 砖 砖,  'remove' 拽:", oldName);
    if(action === 'remove') {
      if(confirm("拽?")) await deleteDoc(doc(db, "people", id));
    } else if(action && action !== oldName) {
      await updateDoc(doc(db, "people", id), { name: action });
    }
  };

  // --- Absence Reasons (Hold Feature) ---
  function startHold(person, e) {
    pressTimer = window.setTimeout(async () => {
      if(isAdmin) {
        const reasons = person.reasons || [];
        alert(`住转 注专转 注专 ${person.name}:\n\n${reasons.length ? reasons.join("\n") : " 住转 专砖转"}`);
      } else {
        const reason = prompt(`注 ${person.name} 住专/?`);
        if(reason) {
          await updateDoc(doc(db, "people", person.id), {
            reasons: arrayUnion(reason)
          });
          alert("住 砖专");
        }
      }
    }, 1000); // 1 second hold
  }

  function clearHold() { clearTimeout(pressTimer); }

</script>
</body>
</html>
